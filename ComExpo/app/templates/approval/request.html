{% extends "base.html" %}

{% block title %}RoomRak - Approval Request{% endblock %}

{% block head_extras %}
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#000000',
                        'accent-orange': '#FFBC7A',
                        'light-gray': '#E5E7EB',
                        'success-green': '#66BB6A',
                        'danger-red': '#EF5350',
                    }
                }
            }
        }
    </script>
{% endblock %}

{% block content %}
    <div id="mobile-menu-overlay" class="mobile-menu-overlay hidden fixed inset-0 bg-black bg-opacity-50 z-50" onclick="toggleMobileMenu()">
        <div class="mobile-menu-content flex flex-col items-start gap-4 bg-white p-6 w-3/4 h-full" onclick="event.stopPropagation()">
            <a href="{{ url_for('main.home') }}" class="text-lg text-primary-dark font-medium hover:text-gray-600 transition w-full py-2 border-b border-light-gray"> Home </a>
            <a href="{{ url_for('booking.new_booking') }}" class="text-lg text-primary-dark font-medium hover:text-gray-600 transition w-full py-2 border-b border-light-gray"> Bookings </a>
            <a href="{{ url_for('history.my_bookings') }}" class="text-lg text-primary-dark font-medium hover:text-gray-600 transition w-full py-2 border-b border-light-gray"> My History </a>
            <a href="{{ url_for('approval.pending_requests') }}" class="text-lg text-primary-dark font-medium hover:text-gray-600 transition w-full py-2 border-b border-light-gray"> Requests </a> 
            <a href="{{ url_for('main.logout') }}" class="text-lg text-white font-semibold bg-primary-dark px-6 py-3 mt-4 hover:bg-gray-700 transition w-full rounded-lg text-center"> Log Out </a>
        </div>
    </div>
    
    <div class="md:hidden flex justify-end px-4 sm:px-6 lg:px-8 pt-4">
        <button id="menu-toggle" class="p-2" onclick="toggleMobileMenu()">
            <svg class="w-7 h-7 text-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
            </svg>
        </button>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <div class="flex justify-end mt-5 sm:mt-10 mb-2 sm:mb-4 w-full">
            <div class="flex items-center bg-accent-orange rounded-full h-10 sm:h-12 w-auto min-w-[180px] sm:min-w-[200px] pr-4 pl-0">
                <div class="user-avatar-pill w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-light-gray border-2 border-primary-dark flex items-center justify-center -ml-2">
                    <svg class="w-6 h-6 sm:w-7 sm:h-7 text-primary-dark" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <div class="flex flex-col justify-center ml-3 leading-tight text-primary-dark">
                    <span class="font-bold text-sm md:text-base">{{ current_user.name }}</span>
                    <span class="font-medium text-xs text-gray-600">{{ current_user.role }}</span>
                </div>
            </div>
        </div>
        
        <hr class="border-gray-300 mb-6 sm:mb-8">

        <h1 class="page-title text-center text-2xl sm:text-3xl lg:text-4xl font-semibold text-primary-dark mb-8">Approval Requests</h1> 
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6">
                    {% for category, message in messages %}
                        <div class="p-4 mb-4 rounded-lg text-center {% if category == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="filter-tabs flex gap-3 sm:gap-4 mb-6 flex-wrap justify-center sm:justify-start">
            <button class="filter-tab active bg-accent-orange font-semibold text-primary-dark px-4 sm:px-6 py-2 rounded-full text-sm transition hover:opacity-80" 
                    data-filter="pending" onclick="filterRequests('pending', this)">
                Pending
            </button>
            <button class="filter-tab bg-light-gray font-medium text-primary-dark px-4 sm:px-6 py-2 rounded-full text-sm transition hover:opacity-80" 
                    data-filter="approved" onclick="filterRequests('approved', this)">
                Approved
            </button>
            <button class="filter-tab bg-light-gray font-medium text-primary-dark px-4 sm:px-6 py-2 rounded-full text-sm transition hover:opacity-80" 
                    data-filter="declined" onclick="filterRequests('declined', this)">
                Rejected
            </button>
        </div>
    </div>

    <div class="bg-accent-orange rounded-3xl p-4 sm:p-8 md:p-10 mx-auto max-w-7xl mb-8 sm:mb-10 px-4 sm:px-6 lg:px-8">
        
        <div class="flex justify-end mb-6 items-center flex-wrap-reverse sm:flex-wrap">
            <span class="font-medium mr-3 text-sm hidden sm:inline">Filter by :</span>
            <input type="text" placeholder="All Post" id="filterInput" oninput="filterBySearch()" 
                   class="px-4 py-2 rounded-full border border-gray-300 w-full sm:w-auto text-sm focus:ring-primary-dark focus:border-primary-dark mt-2 sm:mt-0 max-w-xs sm:max-w-none">
        </div>

        <div class="table-header hidden md:grid grid-cols-6 gap-4 font-semibold text-base text-primary-dark mb-4 px-6 py-3">
            <div class="text-left">Room</div>
            <div class="text-center">Requested Date</div> 
            <div class="text-center">Requested Time</div>
            <div class="text-center">Reason</div> 
            <div class="text-center">Name</div> 
            <div class="text-center">Action</div> 
        </div>

        <div id="requestList">
            {% for booking in bookings %}
            <div class="request-item bg-white rounded-xl p-4 sm:p-6 mb-4 shadow-lg 
                        grid grid-cols-1 gap-2 md:grid-cols-6 md:gap-4 md:items-center text-sm sm:text-base" 
                        data-status="{{ booking.status | lower }}"
                        {# HIDE item if it is not 'pending' (so the default view is clean) #}
                        {% if booking.status != 'Pending' %}style="display: none;"{% endif %}>
                
                <div class="room-code font-bold md:font-normal md:text-left">{{ booking.room_id }}</div>
                <div class="request-date md:text-center">{{ booking.book_date | dateformat }}</div>
                <div class="request-time md:text-center text-gray-700 font-medium">
                    {{ booking.start_time.strftime('%H:%M') }} - {{ booking.end_time.strftime('%H:%M') }}
                </div>
                <div class="request-reason md:text-center italic text-gray-600">"{{ booking.reason }}"</div> 
                <div class="student-name md:text-center font-medium">{{ booking.reserver.name }}</div> 
                
                <div class="action-buttons flex gap-2 justify-start md:justify-center mt-2 md:mt-0">
                    {% if booking.status == 'Pending' %}
                        <form action="{{ url_for('approval.approve_request', reserve_id=booking.reserve_id) }}" method="POST">
                            <button type="submit" class="action-btn bg-green-500 text-white font-semibold px-4 py-1.5 rounded-lg transition hover:bg-green-600 shadow-md">
                                Approve
                            </button>
                        </form>
                        
                        <form action="{{ url_for('approval.decline_request', reserve_id=booking.reserve_id) }}" method="POST">
                            <button type="submit" class="action-btn bg-red-500 text-white font-semibold px-4 py-1.5 rounded-lg transition hover:bg-red-600 shadow-md">
                                Reject
                            </button>
                        </form>
                    
                    {% elif booking.status == 'Approved' %}
                        <div class="flex flex-col items-center">
                            <span class="text-green-600 font-bold bg-green-100 px-3 py-1 rounded-full mb-1">Approved</span>
                            {% if booking.approver %}
                            <span class="text-xs text-gray-500">by {{ booking.approver.name }}</span>
                            {% endif %}
                        </div>
                    {% elif booking.status == 'Declined' %}
                        <div class="flex flex-col items-center">
                            <span class="text-red-600 font-bold bg-red-100 px-3 py-1 rounded-full mb-1">Rejected</span>
                            {% if booking.approver %}
                            <span class="text-xs text-gray-500">by {{ booking.approver.name }}</span>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="bg-white rounded-xl p-8 text-center text-gray-500">
                No bookings found.
            </div>
            {% endfor %}
        </div>
    </div>
    
    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu-overlay');
            menu.classList.toggle('hidden');
        }

        function filterRequests(status, btn) {
            const buttons = document.querySelectorAll('.filter-tab');
            buttons.forEach(b => {
                b.classList.remove('active', 'bg-accent-orange', 'font-semibold');
                b.classList.add('bg-light-gray', 'font-medium');
            });
            
            btn.classList.remove('bg-light-gray', 'font-medium');
            btn.classList.add('active', 'bg-accent-orange', 'font-semibold');

            const items = document.querySelectorAll('.request-item');
            items.forEach(item => {
                const itemStatus = item.getAttribute('data-status');
                if (status === 'history') {
                    item.style.display = 'grid';
                } else if (itemStatus === status) {
                    item.style.display = 'grid';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function filterBySearch() {
            const input = document.getElementById('filterInput');
            const filter = input.value.toUpperCase();
            const items = document.querySelectorAll('.request-item');

            items.forEach(item => {
                const textContent = item.innerText || item.textContent;
                if (textContent.toUpperCase().indexOf(filter) > -1) {
                    item.style.display = "grid";
                } else {
                    item.style.display = "none";
                }
            });
        }
    </script>
{% endblock %}