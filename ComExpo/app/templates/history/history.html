{% extends "base.html" %}

{% block title %}RoomRak - Booking History{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
    /* Basic Layout Styles */
    .center-content { text-align: center; margin-bottom: 2rem; padding-top: 2rem; }
    .page-title { font-size: 2rem; font-weight: bold; margin-bottom: 1.5rem; }
    
    .user-section { display: flex; justify-content: center; margin-bottom: 1.5rem; }
    .user-profile-pill { display: flex; align-items: center; background: white; padding: 0.5rem 1rem; border-radius: 9999px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user-avatar { width: 32px; height: 32px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; }
    .user-avatar-icon { width: 20px; height: 20px; color: #6b7280; }
    .user-name-box { font-weight: 600; color: #374151; }

    /* Filter Tabs */
    .filter-tabs { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
    .filter-tab { padding: 0.5rem 1.5rem; border-radius: 9999px; background: #e0f2fe; color: #0369a1; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s; }
    .filter-tab.active { background: #cbd5e1; color: #0f172a; font-weight: bold; }
    .filter-tab:hover { opacity: 0.9; }

    .filter-search { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1.5rem; }
    #filterInput { border-radius: 9999px; padding: 0.5rem 1rem; border: none; width: 200px; }
</style>
{% endblock %}

{% block content %}
    <div class="center-content">
        <div class="user-section">
            <div class="user-profile-pill">
                <div class="user-avatar">
                    <svg class="user-avatar-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <div class="user-name-box">{{ current_user.name if current_user.name else 'User' }}</div>
            </div>
        </div>
        
        <hr class="border-gray-300 mb-8 max-w-2xl mx-auto">

        <h1 class="page-title">Booking History</h1>

        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all" onclick="filterBookings('all', this)">All ({{ bookings|length }})</button>
            <button class="filter-tab" data-filter="pending" onclick="filterBookings('pending', this)">Pending</button> <button class="filter-tab" data-filter="approved" onclick="filterBookings('approved', this)">Approved</button>
            <button class="filter-tab" data-filter="rejected" onclick="filterBookings('declined', this)">Rejected</button>
        </div>
    </div>

    <div class="max-w-[1200px] mx-auto bg-[#e0f2fe] p-8 rounded-3xl min-h-[400px] overflow-x-auto">
        
        <div class="filter-search">
            <span class="font-medium mr-3 text-sm">Filter by :</span>
            <input type="text" placeholder="All Post" id="filterInput" oninput="filterBySearch()">
        </div>

        <div class="grid grid-cols-5 gap-4 font-bold text-[#1e293b] pb-4 border-b border-black/5 mb-4 min-w-[1100px] text-center">
            <div class="text-left pl-4">Room</div>
            <div>Requested Date</div> 
            <div>Time</div> 
            <div>Reason</div> <div>Status</div> 
        </div>

        <div id="bookingList">
            {% for booking in bookings|sort(attribute='reserve_id', reverse=True) %}
            
            <div class="booking-item bg-white p-6 rounded-2xl mb-4 shadow-sm grid grid-cols-5 gap-4 items-center min-w-[1100px] text-center" 
                 data-status="{{ booking.status | lower }}">
                
                <div class="text-left pl-4 font-bold text-lg">{{ booking.room_id }}</div>
                
                <div class="whitespace-nowrap">{{ booking.book_date | dateformat }}</div>
                
                <div class="text-gray-600 text-sm whitespace-nowrap">
                    {{ booking.start_time.strftime('%H:%M') }} - {{ booking.end_time.strftime('%H:%M') }}
                </div>

                <div class="text-gray-600 text-sm italic truncate px-2" title="{{ booking.reason }}">
                    "{{ booking.reason }}"
                </div>

                <div class="flex flex-col items-center justify-center">
                    {% if booking.status == 'Pending' %}
                        <span class="bg-[#fef08a] text-[#854d0e] px-6 py-1 rounded-full font-bold text-sm w-[110px]">Pending</span>
                    {% elif booking.status == 'Approved' %}
                        <span class="bg-[#86efac] text-[#166534] px-6 py-1 rounded-full font-bold text-sm w-[110px]">Approved</span>
                    {% elif booking.status == 'Declined' or booking.status == 'Rejected' %}
                        <span class="bg-[#fca5a5] text-[#991b1b] px-6 py-1 rounded-full font-bold text-sm w-[110px]">Rejected</span>
                    {% endif %}

                    {% if booking.status != 'Pending' and booking.approver %}
                        <span class="text-xs text-gray-500 mt-1 font-medium whitespace-nowrap">by {{ booking.approver.name }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            {% if not bookings %}
            <div class="bg-white p-6 rounded-2xl mb-4 shadow-sm grid grid-cols-5 gap-4 items-center min-w-[1100px] text-center" data-status="expired">
                <div class="text-left pl-4 font-bold">1115</div>
                <div>22 August 2025</div>
                <div>09:00 - 12:00</div>
                <div>No Reason</div>
                <div class="flex justify-center">
                    <span class="bg-gray-200 text-gray-600 px-6 py-1 rounded-full font-bold text-sm w-[110px]">Expired</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
    function filterBookings(status, btn) {
        const items = document.querySelectorAll('.booking-item');
        const buttons = document.querySelectorAll('.filter-tab');
        
        buttons.forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');

        items.forEach(item => {
            const itemStatus = item.getAttribute('data-status');
            // Logic for Rejected/Declined mismatch
            const showRejected = (status === 'rejected' || status === 'declined') && (itemStatus === 'rejected' || itemStatus === 'declined');
            
            if (status === 'all' || itemStatus === status || showRejected) {
                item.style.display = 'grid'; 
            } else {
                item.style.display = 'none';
            }
        });
    }

    function filterBySearch() {
        const input = document.getElementById('filterInput');
        const filter = input.value.toUpperCase();
        const items = document.querySelectorAll('.booking-item');

        items.forEach(item => {
            // Target the Room Code div (first child)
            const roomCode = item.children[0].innerText;
            if (roomCode.toUpperCase().indexOf(filter) > -1) {
                item.style.display = "grid";
            } else {
                item.style.display = "none";
            }
        });
    }
    </script>
{% endblock %}