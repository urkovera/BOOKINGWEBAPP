{% extends "base.html" %}

{% block title %}RoomRak - Booking History{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
    /* Basic Layout Styles */
    .center-content { text-align: center; margin-bottom: 2rem; padding-top: 2rem; }
    .page-title { font-size: 2rem; font-weight: bold; margin-bottom: 1.5rem; }
    
    .user-section { display: flex; justify-content: center; margin-bottom: 1.5rem; }
    .user-profile-pill { display: flex; align-items: center; background: white; padding: 0.5rem 1rem; border-radius: 9999px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user-avatar { width: 32px; height: 32px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; }
    .user-avatar-icon { width: 20px; height: 20px; color: #6b7280; }
    .user-name-box { font-weight: 600; color: #374151; }

    /* Filter Tabs */
    .filter-tabs { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
    .filter-tab { padding: 0.5rem 1.5rem; border-radius: 9999px; background: #e0f2fe; color: #0369a1; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .filter-tab.active { background: #cbd5e1; color: #0f172a; font-weight: bold; }
    .filter-tab:hover { opacity: 0.9; }

    .filter-search { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1.5rem; }
    #filterInput { border-radius: 9999px; padding: 0.5rem 1rem; border: none; width: 200px; }

    /* --- RESPONSIVE CARD TRANSFORMATION --- */
    @media (max-width: 1024px) {
        /* 1. Hide the Desktop Table Header */
        .desktop-header-row { display: none !important; }

        /* 2. Reset Container Widths */
        .history-container { min-width: 100% !important; padding: 1rem !important; }
        
        /* 3. Transform Row into Card */
        .booking-item {
            display: flex !important;
            flex-direction: column;
            min-width: 100% !important;
            gap: 12px;
            padding: 1.5rem;
            height: auto;
        }

        /* 4. Style each Data Cell as a Row */
        .booking-item > div {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: right;
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: 8px;
        }

        /* 5. Inject Labels using data-label attribute */
        .booking-item > div::before {
            content: attr(data-label);
            font-weight: 700;
            color: #64748b;
            text-align: left;
            margin-right: 1rem;
        }

        /* 6. Special styling for Status */
        .booking-item > div:last-child {
            border-bottom: none;
            justify-content: center;
            margin-top: 8px;
            flex-direction: column;
            gap: 4px;
        }
        .booking-item > div:last-child::before { display: none; }

        /* 7. Reset specific alignments */
        .text-left.pl-4 { padding-left: 0 !important; text-align: right !important; }
        
        /* 8. Search Bar Fix */
        .filter-search { justify-content: center; width: 100%; }
        #filterInput { width: 100%; }
    }

    /* --- CRITICAL FIX: FORCE HIDE --- */
    /* This overrides the display: flex !important in the media query above */
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
    <div class="center-content">
        <div class="user-section">
            <div class="user-profile-pill">
                <div class="user-avatar">
                    <svg class="user-avatar-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <div class="user-name-box">{{ current_user.name if current_user.name else 'User' }}</div>
            </div>
        </div>
        
        <hr class="border-gray-300 mb-8 max-w-2xl mx-auto">

        <h1 class="page-title">Booking History</h1>

        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all" onclick="filterBookings('all', this)">All ({{ bookings|length }})</button>
            <button class="filter-tab" data-filter="pending" onclick="filterBookings('pending', this)">Pending</button> 
            <button class="filter-tab" data-filter="approved" onclick="filterBookings('approved', this)">Approved</button>
            <button class="filter-tab" data-filter="rejected" onclick="filterBookings('declined', this)">Rejected</button>
        </div>
    </div>

    <div class="max-w-[1200px] mx-auto bg-[#e0f2fe] p-8 rounded-3xl min-h-[400px] history-container">
        
        <div class="filter-search">
            <span class="font-medium mr-3 text-sm whitespace-nowrap">Filter by :</span>
            <input type="text" placeholder="Search Room..." id="filterInput" oninput="filterBySearch()">
        </div>

        <div class="desktop-header-row grid grid-cols-5 gap-4 font-bold text-[#1e293b] pb-4 border-b border-black/5 mb-4 min-w-[1100px] text-center">
            <div class="text-left pl-4">Room</div>
            <div>Requested Date</div> 
            <div>Time</div> 
            <div>Reason</div> 
            <div>Status</div> 
        </div>

        <div id="bookingList">
            {% for booking in bookings|sort(attribute='reserve_id', reverse=True) %}
            
            <div class="booking-item bg-white p-6 rounded-2xl mb-4 shadow-sm grid grid-cols-5 gap-4 items-center md:min-w-[1100px] text-center" 
                 data-status="{{ booking.status | lower }}">
                
                <div class="text-left pl-4 font-bold text-lg" data-label="Room">{{ booking.room_id }}</div>
                
                <div class="whitespace-nowrap" data-label="Requested Date">{{ booking.book_date | dateformat }}</div>
                
                <div class="text-gray-600 text-sm whitespace-nowrap" data-label="Time">
                    {{ booking.start_time.strftime('%H:%M') }} - {{ booking.end_time.strftime('%H:%M') }}
                </div>

                <div class="text-gray-600 text-sm italic truncate px-2" title="{{ booking.reason }}" data-label="Reason">
                    "{{ booking.reason }}"
                </div>

                <div class="flex flex-col items-center justify-center" data-label="Status">
                    {% if booking.status == 'Pending' %}
                        <span class="bg-[#fef08a] text-[#854d0e] px-6 py-1 rounded-full font-bold text-sm w-[110px]">Pending</span>
                    
                    {% elif booking.status == 'Approved' %}
                        <span class="bg-[#86efac] text-[#166534] px-6 py-1 rounded-full font-bold text-sm w-[110px]">Approved</span>
                    
                    {% elif booking.status == 'Declined' or booking.status == 'Rejected' %}
                        <span class="bg-[#fca5a5] text-[#991b1b] px-6 py-1 rounded-full font-bold text-sm w-[110px]">Rejected</span>
                    
                    {% elif booking.status == 'Expired' %}
                        <span class="bg-[#f3f4f6] text-[#4b5563] px-6 py-1 rounded-full font-bold text-sm w-[110px]">Expired</span>
                    {% endif %}

                    {% if booking.status != 'Pending' and booking.status != 'Expired' and booking.approver %}
                        <span class="text-xs text-gray-500 mt-1 font-medium whitespace-nowrap">by {{ booking.approver.name }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            {% if not bookings %}
            <div class="booking-item bg-white p-6 rounded-2xl mb-4 shadow-sm grid grid-cols-5 gap-4 items-center md:min-w-[1100px] text-center" data-status="expired">
                <div class="text-left pl-4 font-bold" data-label="Room">1115</div>
                <div data-label="Date">22 August 2025</div>
                <div data-label="Time">09:00 - 12:00</div>
                <div data-label="Reason">No Reason</div>
                <div class="flex justify-center" data-label="Status">
                    <span class="bg-gray-200 text-gray-600 px-6 py-1 rounded-full font-bold text-sm w-[110px]">Expired</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
    function filterBookings(status, btn) {
        const items = document.querySelectorAll('.booking-item');
        const buttons = document.querySelectorAll('.filter-tab');
        
        // 1. Update Active Button Style
        if (buttons && btn) {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // 2. Loop through items
        items.forEach(item => {
            const itemStatus = item.getAttribute('data-status');
            
            // Logic for Rejected/Declined mismatch
            const showRejected = (status === 'rejected' || status === 'declined') && 
                                 (itemStatus === 'rejected' || itemStatus === 'declined');
            
            // 3. SHOW or HIDE
            if (status === 'all' || itemStatus === status || showRejected) {
                // REMOVE the hidden class -> Let CSS decide if it's Grid or Flex
                item.classList.remove('hidden');
            } else {
                // ADD the hidden class -> Hides it completely
                item.classList.add('hidden');
            }
        });
    }

    function filterBySearch() {
        const input = document.getElementById('filterInput');
        const filter = input.value.toUpperCase();
        const items = document.querySelectorAll('.booking-item');

        items.forEach(item => {
            // Search inside entire card text to be safe
            const roomText = item.innerText.toUpperCase(); 

            if (roomText.indexOf(filter) > -1) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }
    </script>
{% endblock %}